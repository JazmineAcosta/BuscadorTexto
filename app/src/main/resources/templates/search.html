<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Buscador de Palabras</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="src/main/resources/static/css/styles.css">
</head>

<body class="container mt-5">
    <h1 class="text-center mb-4">Buscador de Palabras</h1>

    <!-- Formulario para cargar el archivo -->
    <form method="post" enctype="multipart/form-data" th:action="@{/upload}" class="mb-5">
        <div class="mb-3">
            <label for="file" class="form-label">Seleccionar archivo (.txt)</label>
            <input type="file" name="file" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Cargar Archivo</button>
    </form>

    <!-- Mostrar contenido del archivo si está disponible -->
    <div th:if="${content}" class="border p-3">
        <h3>Contenido del archivo:</h3>
        <pre th:text="${content}" class="border p-3 bg-light"></pre>
    </div>

    <!-- Formulario para realizar búsqueda de palabras después de cargar el archivo -->
    <form method="post" enctype="multipart/form-data" th:action="@{/search}" class="mb-5" th:if="${content}">
        <input type="hidden" name="file" value="${file}">
        <div class="mb-3">
            <label for="word" class="form-label">Palabra a buscar:</label>
            <input type="text" name="word" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="algorithm" class="form-label">Algoritmo:</label>
            <select name="algorithm" class="form-select">
                <option value="KMP">KMP.</option>
                <option value="BoyerMoore">Boyer-Moore</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Buscar</button>
    </form>

    <!-- Mostrar resultados de la búsqueda si hay coincidencias -->
    <div th:if="${positions}" class="border p-3">
        <p class="mb-3">
            Se encontraron <span th:text="${count}"></span> coincidencias.
        </p>
        <p>
            Navega entre coincidencias con las flechas (↑, ↓) o Enter.
        </p>

        <p>Contenido del archivo:</p>
        <pre id="contentArea" th:utext="${content}" class="border p-3 bg-light"></pre>

        <!-- Incluimos un campo oculto para las posiciones -->
        <input type="hidden" id="positions" th:value="${positions}" th:if="${positions}">

    </div>

    <!-- Bootstrap JS y Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Scripts para manejar resaltado y navegación -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let currentPosition = 0;
            const contentArea = document.getElementById('contentArea');
            const positionsInput = document.getElementById('positions');

            let positions = [];
            if (positionsInput && positionsInput.value) {
                try {
                    positions = JSON.parse(positionsInput.value); // Obtener posiciones solo si hay datos
                } catch (e) {
                    console.error("Error al parsear posiciones:", e);
                }
            }

            const word = "[[${word}]]"; // Palabra a buscar

            // Función para resaltar todas las coincidencias en el contenido
            function highlightAll() {
                let content = contentArea.innerHTML;
                let regex = new RegExp(`(${word})`, 'gi');  // Case insensitive
                content = content.replace(regex, '<span class="highlight">$1</span>');
                contentArea.innerHTML = content;
            }

            // Función para resaltar la posición actual
            function highlightCurrent(index) {
                const highlights = document.querySelectorAll('.highlight');
                highlights.forEach(h => h.classList.remove('current-position'));
                if (highlights[index]) {
                    highlights[index].classList.add('current-position');
                    highlights[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            // Navegación de coincidencias
            function navigateResults(direction) {
                currentPosition += direction;
                if (currentPosition < 0) {
                    currentPosition = positions.length - 1;
                } else if (currentPosition >= positions.length) {
                    currentPosition = 0;
                }
                highlightCurrent(currentPosition);
                updateCounter();
            }

            // Actualizar el contador de coincidencias (Ej: 5/8)
            function updateCounter() {
                const counter = document.querySelector('p > span');
                if (counter) {
                    counter.innerText = `${currentPosition + 1}/${positions.length}`;
                }
            }

            // Eventos de teclado para avanzar o retroceder
            document.addEventListener('keydown', function (e) {
                if (e.key === 'ArrowDown' || e.key === 'Enter') {
                    e.preventDefault();  // Evitar comportamiento predeterminado
                    navigateResults(1);  // Avanzar a la siguiente coincidencia
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateResults(-1);  // Retroceder a la coincidencia anterior
                }
            });

            // Inicializamos el resaltado y la navegación si hay posiciones
            if (positions.length > 0) {
                highlightAll();
                highlightCurrent(currentPosition);
                updateCounter();
            }
        });
    </script>
</body>

</html>